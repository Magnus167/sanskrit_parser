# -*- coding: utf-8 -*-
# Sutras for ac sandhi
#  @author: kmadathil

# Preefined variables, can be used as lvalues and rvalues in xform and
# lvalues in conditions. To use a variable as rvalue in a condition,
# prefix with $ (eg l: $r checkes for savarnatva between l and r)
#
#   lp = left pada
#   rp = right pada
#   l = last varna of left pada
#   r = first varna of right pada
#  ll = second last varna of left pada
#  rr = second varna of right pada
#  lc = left pada except last varna
#  rc = right pada except first varna
#  olp = output left pada (Used only for tagging outputs)
#  orp = output right pada (Used only for tagging outputs)

# Sutra: Name
# Id: <adhyAya.pAda.sutra>
# Condition: boolean
# Every boolean is a(n or reduced list of) var: <value> and conditions
#     l: a - l is savarna of a varna
#     l: ut - l is short u varna
#     r: ku - l is kavarga
#     r: _ac - r is in pratyahara "ac"
#     r: $l  - r is savarna of l (variable)
#    rp: =naam - rp is exactly the string "naam"
#    lp: ?pada - lp has tag pada
#    lp: !pada - lp does not have tag pada
#    rp: +Y   - rp is a pratyaya with it Y
#
# Trigger: (list of) global triggers needed to enable this rule
#
# Xform: dict of transformations. Each transformation is a python expression
#    l: dirgha(l)
#    r: ""
# 
# Update:
#   lp: +ru - sets tag "ru" on lp
#   rp: -pada - removes "pada" tag from rp
#   trigger: - sets triggers
#     uran_trigger:   - sets trigger uran_trigger 
#         value: True - to True
#           condition:  - if
#              r: f       - r = "f"

# ac sandhi

# FIXME - create samhita adhikaras
# Three 6.1.72, 6.3.115, 8.2.108
-   sutra: इको यणचि
    id: 6.1.77
    condition:
      l: _ik
      r: _ac
    xform:
      l: ikoyan(l)
       
-   sutra: एचोऽयवायावः
    id: 6.1.78
    condition:
      l: _ec
      r: _ac
    xform:
       l: ayavayav(l)
       
-   sutra: वान्तो यि प्रत्यये 
    id: 6.1.79
    condition:
      l: [o, O]
      r: y
      rp: ?pratyaya
    xform:
       l: ayavayav(l)

# 64: धातोस्तन्निमित्तस्यैव (6-1-80) 
-   sutra:  धातोस्तन्निमित्तस्यैव 
    id: 6.1.80
    overrides: 6.1.79   
    condition:
      l: [o, O]
      lp:
        - and
        - ?DAtu
        - ?!tannimitta
      r: y
      rp: ?pratyaya
    xform: null
    
# 65: क्षय्यजय्यौ शक्यार्थे (6-1-81)
-   sutra:  क्षय्यजय्यौ शक्यार्थे 
    id: 6.1.81
    overrides: 6.1.79
    optional: true
    condition:
      l: et
      lc:
        - =kz
        - =j
      lp: ?DAtu
      r: y
      rp: ?pratyaya
    xform:
       l: ayavayav(l)

# 66: क्रय्यस्तदर्थे (6-1-82) 
-   sutra:  क्रय्यस्तदर्थे 
    id: 6.1.82
    overrides: [6.1.79, 7.3.84]
    optional: true
    condition:
      lc: =kr
      l: et
      lp: ?DAtu
      r: y
      rp: ?pratyaya
    xform:
       l: ayavayav(l)


# FIXME PurvaparayoH needs a bit more thought
-   sutra: आद्गुणः
    id: 6.1.87
    condition:
       l: a
       r: _ik
    xform:
       l: null
       r: guna(r)
    trigger: null
    update:
      olp: -pada # for pUrvaparayoH
    # update:
    #   trigger:
    #     uran_trigger:
    #       value: True
    #       condition:
    #          r: f

-   sutra: वृद्धिरेचि
    id: 6.1.88
    condition:
       l: a
       r: _ec
    xform:
       l: vriddhi(r)
       r: null
    trigger: null
    update:
      olp: -pada # for pUrvaparayoH


# 73: एत्येधत्यूठ्सु (6-1-89) 
-   sutra: एत्येधत्यूठ्सु
    id: 6.1.89
    overrides: 6.1.94
    condition:
     - l: a
       rp:
         - ?eti
         - ?UW
         - ?eDati
    xform:
       l: null
       r: vriddhi(r)
    trigger: null
    update:
       olp: -pada # for pUrvaparayoH
   
# 74: उपसर्गादृति धातौ (6-1-91)
-   sutra: उपसर्गादृति धातौ 
    id: 6.1.91
    condition:
     - l: a
       lp: ?upasarga
       r: f
       #rp: ?DAtu
    xform:
       l: null
       r: vriddhi(r)
    trigger: null
    update:
      olp: -pada # for pUrvaparayoH

# 78: एङि पररूपम् (6-1-94)
-   sutra:  एङि पररूपम् 
    id: 6.1.94
    condition:
       l: a
       lp: ?upasarga
       r: eN
       # rp: ?DAtu
    xform:
       l: null
    update:
      olp: -pada # for pUrvaparayoH

# 80: ओमाङोश्च (6-1-95) 
-   sutra:  ओमाङोश्च 
    id: 6.1.95
    condition:
       rp:
        - =om
        - ?AN
    xform:
       l: null
    update:
      olp: -pada # for pUrvaparayoH
      
#  191: अतो गुणे (6-1-97)
-   sutra:  अतो गुणे
    id: 6.1.97
    overrides: 6.1.101
    condition:
       l: a
       lp: ?!pada
       r: [at, _eN]
    xform:
       l: null
    update:
      olp: -pada # for pUrvaparayoH

# 164: प्रथमयोः पूर्वसवर्णः (6-1-102)
-   sutra:  प्रथमयोः पूर्वसवर्णः 
    id: 6.1.102
    overrides: 6.1.97
    condition:
       l: _ak
       r: _ac
       rp:
         - ?praTamA
         - ?dvitIyA
    xform:
       r: l
       
 # 196: तस्माच्छसो नः पुंसि (6-1-103)
-   sutra:  तस्माच्छसो नः पुंसि 
    id: 6.1.103
    overrides: 6.1.97
    condition:
       l: _ak
       rp:
         - and
         - =as
         - ?dvitIyA
    xform:
       r: l
       rc: str("n")
       
# 193: एङ्ह्रस्वात्संबुद्धेः (6-1-69)
-   sutra: एङ्ह्रस्वात्संबुद्धेः
    id: 6.1.69
    condition:
       l: [at, it, ut, _eN]
       r: _hal
       rp:
         - ?sambudDi
    xform:
       r: null
       
# 194: अमिपूर्वः (6-1-107) 
-   sutra:  अमिपूर्वः
    id: 6.1.107
    condition:
       l: _ak
       rp:
         - and
         - =am
         - ?pratyaya
    xform:
       r: null
 
#165: नादिचि (6-1-104) 
-   sutra: नादिचि
    id: 6.1.104
    overrides: 6.1.102
    condition:
       l: a
       r: _ic
       rp:
         - ?praTamA
         - ?dvitIyA
    xform: null

# 90: प्लुतप्रगृह्या अचि नित्यम् (6-1-125)
-   sutra:  प्लुतप्रगृह्या अचि नित्यम् 
    id: 6.1.125
    condition:
       lp:
        - ?pluta
        - ?pragfhya
       r: _aC
    xform:
       l: null

# FIXME - test this once we do dvicacana
# 100: ईदूदेद्द्विवचनं प्रगृह्यम् (1-1-11) 
-   sutra:  ईदूदेद्द्विवचनं प्रगृह्यम्
    id: 1.1.11
    condition:
      l: [It, Ut, et]
      lp: ?dvivacana
    update:
      olp: +pragfhya
      
# FIXME - test this once we do adas
# 101: अदसोमात् (1-1-12) 
-   sutra: अदसोमात्
    id: 1.1.12
    condition:
      l: [It, Ut, et]
      ll: m
      lp: ?adas
    update:
      olp: +pragfhya


# Better handled as a paribhAshA
# -   sutra: उरण् रपरः
#     id: 1.1.51
#     condition: null
#     xform:
#        r: str("r")+r
#     trigger: uran_trigger 
#     update:
#       trigger:
#         uran_trigger:
#           value: False
       
-   sutra: अकः सवर्णे दीर्घः
    id: 6.1.101
    condition:
      l: _ak
      r: $l
    xform:
      l: dirgha(l)
      r: null

-   sutra: एङः पदान्तादति
    id: 6.1.109
    condition:
      l: _eN
      r: at
      lp: ?pada
    xform:
      r: null

# hal sandhi
- sutra: छे च
  id: 6.1.73
  condition:
     l: [at,it,ut,ft,xt]
     r: C
  insert:
     1: tuk

# Fixme - need to check for Nit
- sutra: आङ्माङोश्च
  id: 6.1.74
  overrides: [6.1.75, 6.1.76]
  condition:
     - lp:
        - and
        - =A
        - +N
       r: C
     - lp:
        - and
        - =mA
        - +N       
       r: C
  insert:
     1: tuk
     
- sutra: दीर्घात्
  id: 6.1.75
  condition:
     l: [At, It, Ut, Ft, Xt, e, o]
     r: C
  insert:
     1: tuk
     
- sutra: पदान्ताद्वा
  id: 6.1.76
  overrides: 6.1.75
  optional: true
  condition:
     l: [At, It, Ut, Ft, Xt, e, o]
     lp: ?pada
     r: C
  insert:
     1: tuk

- sutra: स्तोः श्चुना श्चुः
  id: 8.4.40
  condition:
      - l: [s, tu]
        r: [S, cu]
      - l: [S, cu]
        r: [s, tu]
  xform:
      r: shcutva(r)
      l: shcutva(l)

- sutra: ष्टुना ष्टुः
  id: 8.4.41
  condition:
      - l: [s, tu]
        r: [z, wu]
      - l: [z, wu]
        r: [s, tu]
  xform:
      r: zwutva(r)
      l: zwutva(l)

- sutra: न पदान्ताट्टोरनाम्
  id: 8.4.42
  overrides: 8.4.41
  condition:
        lp: ?pada
        l: wu
        r: [s, tu]
  xform: null

# Subsutra plus vArtikas
- sutra: न पदान्ताट्टोरनाम्
  id: 8.4.42.1
  overrides: [8.4.42, 8.4.41]
  condition:
        l: wu
        rp: [=nAm, =navatis, =nagaris]
  xform:
        r: zwutva(r)
        
- sutra: तोः षि
  id: 8.4.43
  overrides: 8.4.41
  condition:
        l: tu
        r: z
  xform:
- sutra: शात्
  id: 8.4.44
  overrides: 8.4.40
  condition:
        l: S
        r: [s, tu]
  xform:

- sutra: लोपः शाकल्यस्य
  id: 8.3.19
  condition:
     lp: ?pada
     l: y
     ll: a
     r: _aS
  xform:
     l: null

- sutra: ओतो गार्ग्यस्य
  id: 8.3.20
  condition:
     l: y
     ll: o
     r: _aS
  xform:
     l: null

# Pada disabled per kashika
- sutra: ढो ढे लोपः
  id: 8.3.13
  condition:
     #lp: ?pada
     l: Q
     r: Q
  xform:
     l: null
  update:
     olp: +qrlopa
     
- sutra: रो रि
  id: 8.3.14
  condition:
     #lp: ?pada
     l: r
     r: r
  xform:
     l: null
  update:
     olp: +qrlopa

# 8.3.13/14 are siddha for this sutra
- sutra: ढ्रलोपे पूर्वस्य दीर्घोऽणः
  id: 6.3.111
  condition:
     lp: ?qrlopa
     l: _aR
  xform:
     l: dirgha(l)

- sutra: अनुस्वारस्य ययि परसवर्णः
  id: 8.4.58
  condition:
     l: M
     r: _yay
  xform:
     l: anunasika(r)

#optional at pada end
- sutra: वा पदान्तस्य
  id: 8.4.59
  overrides: 8.4.58
  optional: True
  condition:
     lp: ?pada
     l: M
     r: _yay
  xform:
     l: anunasika(r)

- sutra: मोऽनुस्वारः
  id: 8.3.23
  condition:
     l: m
     r: _hal
  xform:
     l: str("M")

- sutra: यरोऽनुनासिकेऽनुनासिको वा 
  id: 8.4.45
  optional: True
  #overrides: 8.2.39
  condition:
     l: _yar
     r: [N,Y,R,n,m]
  xform:
     l: anunasika(l)

- sutra: झलां जशोऽन्ते
  id: 8.2.39
  condition:
   - lp: ?pada
     l: _Jal
     r: _aS
   - lp: ?pada
     l: _Jal
     rp: ?avasAna
  xform:
     l: jashtva(l)

- sutra: खरि च
  id: 8.4.55
  condition:
     l: _Jal
     r: _Kar
  xform:
     l: chartva(l)

- sutra: वाऽवसाने
  id: 8.4.56
  optional: true
  condition:
     l: _Jal
     rp: ?avasAna
  xform:
     l: chartva(l)
     
# Fixme: handle savarna of n - भवान् + लिखति = भवाल्ँलिखति । 
- sutra: तोर्लि
  id: 8.4.60
  overrides: 8.2.39
  condition:
     l: tu
     r: l
  xform:
     l: r

- sutra: उदः स्थास्तम्भोः पूर्वस्य सवर्णः
  id: 8.4.61
  #overrides: 8.2.39
  condition:
     lp: =ut
     rp:
       - ?sTA
       - ?sTamB
  xform:
     r: str("T")


#  FIXME: Collect Pada adhikara from 8.1.16
- sutra: संयोगान्तस्य लोपः
  id: 8.2.23
  condition:
     lp: ?pada
     ll: _hal
     l:  _hal
  xform:
     l: null

# Vartikam
- sutra: यणः प्रतिषेधो वाच्यः 
  id: 8.2.23.1
  overrides: 8.2.23
  condition:
     lp: ?pada
     ll: _hal
     l:  _yaR
  xform:

- sutra: चोः कुः
  id: 8.2.30
  condition:
     - lp: ?pada
       l: cu
     - l: cu
       r: _Jal
  xform:
     l: kutva(l)

- sutra: हो ढः
  id: 8.2.31
  condition:
     - lp: ?pada
       l: h
     - l: h
       r: _Jal
  xform:
     l: str("Q")
     
- sutra: झषस्तथोर्धोऽधः
  id: 8.2.40
  condition:
     - l: _Jaz
       r: t
       lp:
        - and
        - ?DAtu
        - ?!DA
  xform:
     r: str("D")


- sutra: ङमोः ह्रस्वादचि ङमुण् नित्यम्
  id: 8.3.32
  condition:
     ll: [at, it, ut, ft]
     l: _Nam
     r: _ac
     lp: ?pada
  xform:
     r: l+r


# End Pada adhikara 8.3.54

- sutra: झलां जश् झशि
  id: 8.4.53
  condition:
     l: _Jal
     r: _JaS
  xform:
     l: jashtva(l)

- sutra: झयो होऽन्यतरस्याम्
  optional: True
  id: 8.4.62
  condition:
     l: _Jay
     r: h
  xform:
     r: vargatritiya(l)


# vartikam छत्वममि इति वक्तव्यम् incorprated
- sutra: शश्छोऽटि
  id: 8.4.63
  optional: True
  condition:  
     l: _Jay
     r: S
     rr: _am
  xform:
     r: str("C")

- sutra: शि तुक्
  id: 8.3.31
  condition:
     l: n
     r: S
     lp: ?pada
  optional: true
  insert:
     1: tuk


# Sutras in this adhikara set the ru_anu tag to backtrigger 8.3.2/3/4
# - sutra: अत्रानुनासिकः पूर्वस्य तु वा
#   id: 8.3.2
#   optional: True
#   condition:
#       lp: ?ru_anu
#   xform:
#       l: str("~r")
#   update:
#       olp: -ru_anu

- sutra: अनुनासिकात् परोऽनुस्वारः
  id: 8.3.4
  condition:
      lp: ?ru_anu
  xform:
      l: str("Mr")
  update:
      olp: -ru_anu
      
- sutra: नश्छव्यप्रशान्
  id: 8.3.9
  condition:
     l: n
     r: _Cav
     rr: _am
  xform:
     l: str("r")
  update:
     # Set on input to backtrigger 8.3.2/3/4
     lp: [+ru, +ru_anu]


# 8.3.12 - End of 8.3.2 adhikara

# "Visarga" Sandhi
- sutra: ससजुषो रुः
  id: 8.2.66
  overrides: 8.2.39
  condition:  
     l: s
     lp: ?pada
  xform:
     l: str("r")
  update:
     olp: +ru
     # Have to do this to back-trigger 6.1.113
     lp: +ru

- sutra: अतो रोरप्लुतादप्लुते
  id: 6.1.113
  overrides: [8.3.17, 8.4.46]
  condition:  
     lp: ?ru
     #l: r
     ll: at
     r: at
  xform:
     # FIXME: change this to "u" when sliding windows are done
     l: str("o")
     lc: lc[:-1]

- sutra: हशि च
  id: 6.1.114
  overrides: [8.3.17, 8.4.46]
  condition:  
     lp: ?ru
     #l: r
     ll: at
     r: _haS
  xform:
     # FIXME: change this to "u" when sliding windows are done
     l: str("o")
     lc: lc[:-1]

- sutra: भोभगोअघोअपूर्वस्य योऽशि
  id: 8.3.17
  condition:
     - ll: a
       #l:  r
       lp: ?ru
       r: _aS
     - lc: [=Bo, =Bago, =aGo]
       #l:  r
       lp: ?ru
       r: _aS
  xform:
     l: str("y")

- sutra: खरवसानयोर्विसर्जनीयः
  id: 8.3.15
  condition:
     - l:  r
       r: _Kar
       lp: ?pada
     - l:  r
       lp: ?pada
       rp: ?avasAna
  xform:
     l: str("H")
     
- sutra: विसर्जनीयस्य सः
  id: 8.3.34
  condition:
     l:  H
     r: _Kar
     lp: ?pada
  xform:
     l: str("s")
     
- sutra: शर्परे विसर्जनीयः
  id: 8.3.35
  overrides: 8.3.34
  condition:
     l:  H
     r: _Kar
     rr: _Sar
     lp: ?pada

- sutra: वा शरि
  id: 8.3.36
  overrides: 8.3.34
  optional: True
  condition:
     l:  H
     r: _Sar
     lp: ?pada
  xform:
     l: str("s")

# FIXME: Ignoring updaDmanIya and jihvAmUlIya as they're not seen in practice
- sutra: कुप्वोः ≍क≍पौ च
  id: 8.3.37
  overrides: 8.3.34
  condition:
     l:  H
     r: [ku, pu]
     lp: ?pada
  xform:
     l: l
 
- sutra: अचो रहाभ्यां द्वे
  id: 8.4.46
  optional: true
  condition:  
     ll:  _ac
     l: [r, h]
     r: _yar
  xform:
     r: r+r

# FIXME -causes too many problems. We'll go with sarvatra SAkalyasya on this
# Until we can fix this ;-)
# - sutra: अनचि च
#   id: 8.4.47
#   optional: true
#   condition:  
#      ll: _ac
#      l: _yar
#      r: _hal
#   xform:
#      l: l+l

- sutra: हलो यमां यमि लोपः
  id: 8.4.64
  optional: true
  condition:  
     ll:  _hal
     l: _yam
     r: $l
  xform:
     l: null

# FIXME - savarna of l
- sutra: झरो झरि सवर्णे
  id: 8.4.65
  optional: true
  condition:  
     - ll:  _hal
       l: _Jar
       r: $l
  xform:
     l: null
- sutra: झरो झरि सवर्णे
  id: 8.4.65.1
  optional: true
  condition:  
     - l:  _hal
       r: _Jar
       rr: $r
  xform:
     r: null


## Rules added for pratyayas etc.
# aNga adhikara
- sutra: अचो ञ्णिति
  id: 7.2.115
  condition:
     lp: ?aNga
     l: _ac
     rp: [+R, +Y]
  xform:
     l: vriddhi(l)
  update:
     olp: +tannimitta
     
- sutra: अत उपधायाः
  id: 7.2.116
  condition:
     lp: ?aNga
     ll: at
     rp: [+R, +Y]
  xform:
     lc: lc[:-1]+str("A")
  update:
     olp: +tannimitta
     
- sutra: सार्वधातुकार्धधातुकयोः
  id: 7.3.84
  condition:
     - lp: ?aNga
       l: _ac
       rp:
         - ?ArDaDAtuka
         - ?sArvaDAtuka
  xform:
     l: guna(l)
     
- sutra: पुगन्तलघूपधस्य च
  id: 7.3.86
  condition:
     - lp: ?aNga
       ll: [it, ut, ft, xt]
       rp:
         - ?ArDaDAtuka
         - ?sArvaDAtuka
  xform:
     lc: lc[:-1]+guna(lc[-1])
     
- sutra: क्ङिति च
  id: 1.1.5
  overrides: [7.3.84, 7.3.86]
  condition:
     - lp: ?aNga
       rp:
         - +k
         - +N
  xform: null

# TadDita adhikAra
- sutra: ओर्गुणः
  id: 6.4.146
  overrides: [7.2.115, 7.2.116]
  condition:
     lp: ?aNga
     l: u
     rp:
       - and
       - ?tadDita
       - ?svAdi
       - ?!sarvanAmasTAna
  xform:
     l: guna(l)
     
- sutra: तद्धितेष्वचामादेः
  id: 7.2.117
  condition:
   - lp: ?aNga
     rp:
       - and
       - ?tadDita
       - +R
   - lp: ?aNga
     rp:
       - and
       - ?tadDita
       - +Y
  xform:
     lc: adivriddhi(lc)

# End taddhita adhikara
# End aNga adhikara

# FIXME get this working - need different Domains
- sutra: यचि भम्
  id: 1.4.18
  condition:
     rp:
       - "and"
       - ?svAdi
       - ?!sarvanAmasTAna
     r: [y, _ac]
  update:
     olp: +Ba

# Skipping for now

# In
# अथ अच्सन्धिप्रकरणम्‌ ॥
# 55: नादिन्याक्रोशे पुत्रस्य (8-4-48)
# 56: त्रिप्रभृतिषु शाकटायनस्य (8-4-50)
# 57: सर्वत्र शाकल्यस्य (8-4-51)
# 58: दीर्घादाचार्याणाम् (8-4-52)

# 75: अन्तादिवच्च (6-1-85)
# 77: वासुप्यापिशलेः (6-1-92)
# 81: अव्यक्तानुकरणस्यात इतौ (6-1-98)
# 82: नाम्रेडितस्यान्त्यस्य तु वा (6-1-99)
# 87: सर्वत्र विभाषा गोः (6-1-122)
# 88: अवङ् स्फोटायनस्य (6-1-123)
# 89: इन्द्रे च (6-1-124)

# प्रकृतिभावप्रकरणम्‌
# 90-110 barring 90,100,101

# halsandhiप्रकरणम्‌
# 127: हे मपरे वा (8-3-26)
# 129: न परे नः (8-3-27) 
# 130: ङ्णोः कुक् टुक् शरि (8-3-28) 
# 131: डः सि धुट् (8-3-29)
# 132: नश्च (8-3-30) 

# विसर्गसन्धिप्रकरणम्‌
# 8.3.38-42

# For Later

# kvip etc.
# 126: मो राजि समः क्वौ (8-3-25)
# ru
# 135: समः सुटि (8-3-5)
# 139: पुमः खय्यम्परे (8-3-6)
# 141: नॄन्पे (8-3-10)
# 143: कानाम्रेडिते (8-3-12)
# 144: कस्कादिषु च (8-3-48)

# Soon
# viBakti - need for non adanta
# 197: अट्कुप्वाङ्नुम्व्यवायेऽपि (8-4-2)
# 198: पदान्तस्य (8-4-37) 